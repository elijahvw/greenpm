{"ast":null,"code":"import React,{useState,useEffect}from'react';import{useAuth}from'../contexts/AuthContext';import{MessageService}from'../services/api';import{PlusIcon,MagnifyingGlassIcon,ChatBubbleLeftRightIcon,PaperAirplaneIcon,EllipsisVerticalIcon}from'@heroicons/react/24/outline';import{jsx as _jsx,jsxs as _jsxs,Fragment as _Fragment}from\"react/jsx-runtime\";const Messages=()=>{var _selectedThread$parti;const{user}=useAuth();const[threads,setThreads]=useState([]);const[selectedThread,setSelectedThread]=useState(null);const[messages,setMessages]=useState([]);const[newMessage,setNewMessage]=useState('');const[loading,setLoading]=useState(true);const[error,setError]=useState(null);const[searchTerm,setSearchTerm]=useState('');useEffect(()=>{fetchThreads();},[]);useEffect(()=>{if(selectedThread){fetchMessages(selectedThread.id);}},[selectedThread]);const fetchThreads=async()=>{try{setLoading(true);const data=await MessageService.getThreads();setThreads(data.threads);}catch(err){setError(err.message||'Failed to fetch message threads');}finally{setLoading(false);}};const fetchMessages=async threadId=>{try{const data=await MessageService.getMessages(threadId);setMessages(data.messages);// Mark thread as read\nawait MessageService.markThreadRead(threadId);}catch(err){setError(err.message||'Failed to fetch messages');}};const handleSendMessage=async e=>{e.preventDefault();if(!newMessage.trim()||!selectedThread)return;try{await MessageService.sendMessage({thread_id:selectedThread.id,content:newMessage.trim()});setNewMessage('');fetchMessages(selectedThread.id);fetchThreads();// Refresh thread list\n}catch(err){setError(err.message||'Failed to send message');}};const filteredThreads=threads.filter(thread=>{var _thread$subject,_thread$participants;return((_thread$subject=thread.subject)===null||_thread$subject===void 0?void 0:_thread$subject.toLowerCase().includes(searchTerm.toLowerCase()))||((_thread$participants=thread.participants)===null||_thread$participants===void 0?void 0:_thread$participants.some(p=>{var _p$email;return(_p$email=p.email)===null||_p$email===void 0?void 0:_p$email.toLowerCase().includes(searchTerm.toLowerCase());}));});if(loading){return/*#__PURE__*/_jsx(\"div\",{className:\"flex items-center justify-center h-64\",children:/*#__PURE__*/_jsx(\"div\",{className:\"animate-spin rounded-full h-32 w-32 border-b-2 border-green-500\"})});}return/*#__PURE__*/_jsxs(\"div\",{className:\"flex h-screen bg-white\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"w-1/3 border-r border-gray-200 flex flex-col\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"p-4 border-b border-gray-200\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"flex items-center justify-between\",children:[/*#__PURE__*/_jsx(\"h1\",{className:\"text-xl font-semibold text-gray-900\",children:\"Messages\"}),/*#__PURE__*/_jsx(\"button\",{className:\"p-2 text-gray-400 hover:text-gray-600\",children:/*#__PURE__*/_jsx(PlusIcon,{className:\"h-5 w-5\"})})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"mt-4 relative\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none\",children:/*#__PURE__*/_jsx(MagnifyingGlassIcon,{className:\"h-5 w-5 text-gray-400\"})}),/*#__PURE__*/_jsx(\"input\",{type:\"text\",value:searchTerm,onChange:e=>setSearchTerm(e.target.value),className:\"block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md leading-5 bg-white placeholder-gray-500 focus:outline-none focus:placeholder-gray-400 focus:ring-1 focus:ring-green-500 focus:border-green-500 sm:text-sm\",placeholder:\"Search messages...\"})]})]}),/*#__PURE__*/_jsx(\"div\",{className:\"flex-1 overflow-y-auto\",children:filteredThreads.length===0?/*#__PURE__*/_jsx(\"div\",{className:\"p-4 text-center text-gray-500\",children:searchTerm?'No threads found':'No messages yet'}):filteredThreads.map(thread=>{var _user$id;return/*#__PURE__*/_jsx(ThreadItem,{thread:thread,isSelected:(selectedThread===null||selectedThread===void 0?void 0:selectedThread.id)===thread.id,onClick:()=>setSelectedThread(thread),currentUserId:user===null||user===void 0?void 0:(_user$id=user.id)===null||_user$id===void 0?void 0:_user$id.toString()},thread.id);})})]}),/*#__PURE__*/_jsx(\"div\",{className:\"flex-1 flex flex-col\",children:selectedThread?/*#__PURE__*/_jsxs(_Fragment,{children:[/*#__PURE__*/_jsx(\"div\",{className:\"p-4 border-b border-gray-200\",children:/*#__PURE__*/_jsxs(\"div\",{className:\"flex items-center justify-between\",children:[/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(\"h2\",{className:\"text-lg font-medium text-gray-900\",children:selectedThread.subject||'Conversation'}),/*#__PURE__*/_jsxs(\"p\",{className:\"text-sm text-gray-500\",children:[(_selectedThread$parti=selectedThread.participants)===null||_selectedThread$parti===void 0?void 0:_selectedThread$parti.length,\" participants\"]})]}),/*#__PURE__*/_jsx(\"button\",{className:\"p-2 text-gray-400 hover:text-gray-600\",children:/*#__PURE__*/_jsx(EllipsisVerticalIcon,{className:\"h-5 w-5\"})})]})}),/*#__PURE__*/_jsx(\"div\",{className:\"flex-1 overflow-y-auto p-4 space-y-4\",children:messages.map(message=>/*#__PURE__*/_jsx(MessageItem,{message:message,isOwn:message.sender_id===(user===null||user===void 0?void 0:user.id)},message.id))}),/*#__PURE__*/_jsx(\"div\",{className:\"p-4 border-t border-gray-200\",children:/*#__PURE__*/_jsxs(\"form\",{onSubmit:handleSendMessage,className:\"flex space-x-2\",children:[/*#__PURE__*/_jsx(\"input\",{type:\"text\",value:newMessage,onChange:e=>setNewMessage(e.target.value),placeholder:\"Type a message...\",className:\"flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-green-500 focus:border-green-500\"}),/*#__PURE__*/_jsx(\"button\",{type:\"submit\",disabled:!newMessage.trim(),className:\"px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed\",children:/*#__PURE__*/_jsx(PaperAirplaneIcon,{className:\"h-5 w-5\"})})]})})]}):/*#__PURE__*//* Empty State */_jsx(\"div\",{className:\"flex-1 flex items-center justify-center\",children:/*#__PURE__*/_jsxs(\"div\",{className:\"text-center\",children:[/*#__PURE__*/_jsx(ChatBubbleLeftRightIcon,{className:\"mx-auto h-12 w-12 text-gray-400\"}),/*#__PURE__*/_jsx(\"h3\",{className:\"mt-2 text-sm font-medium text-gray-900\",children:\"No conversation selected\"}),/*#__PURE__*/_jsx(\"p\",{className:\"mt-1 text-sm text-gray-500\",children:\"Choose a conversation from the sidebar to start messaging\"})]})})}),error&&/*#__PURE__*/_jsxs(\"div\",{className:\"fixed bottom-4 right-4 bg-red-500 text-white px-4 py-2 rounded-md shadow-lg\",children:[error,/*#__PURE__*/_jsx(\"button\",{onClick:()=>setError(null),className:\"ml-2 text-red-200 hover:text-white\",children:\"\\xD7\"})]})]});};const ThreadItem=_ref=>{var _thread$participants2;let{thread,isSelected,onClick,currentUserId}=_ref;const otherParticipants=((_thread$participants2=thread.participants)===null||_thread$participants2===void 0?void 0:_thread$participants2.filter(p=>p.id!==currentUserId))||[];return/*#__PURE__*/_jsxs(\"div\",{onClick:onClick,className:`p-4 border-b border-gray-100 hover:bg-gray-50 cursor-pointer ${isSelected?'bg-green-50 border-green-200':''}`,children:[/*#__PURE__*/_jsxs(\"div\",{className:\"flex items-center justify-between\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"flex-1 min-w-0\",children:[/*#__PURE__*/_jsx(\"p\",{className:\"text-sm font-medium text-gray-900 truncate\",children:thread.subject||'No subject'}),/*#__PURE__*/_jsx(\"p\",{className:\"text-sm text-gray-500 truncate\",children:otherParticipants.map(p=>p.email).join(', ')})]}),/*#__PURE__*/_jsx(\"div\",{className:\"flex-shrink-0 ml-2\",children:/*#__PURE__*/_jsx(\"p\",{className:\"text-xs text-gray-500\",children:new Date(thread.last_message_at).toLocaleDateString()})})]}),thread.last_message&&/*#__PURE__*/_jsx(\"p\",{className:\"mt-1 text-sm text-gray-600 truncate\",children:thread.last_message})]});};const MessageItem=_ref2=>{let{message,isOwn}=_ref2;return/*#__PURE__*/_jsx(\"div\",{className:`flex ${isOwn?'justify-end':'justify-start'}`,children:/*#__PURE__*/_jsxs(\"div\",{className:`max-w-xs lg:max-w-md px-4 py-2 rounded-lg ${isOwn?'bg-green-600 text-white':'bg-gray-100 text-gray-900'}`,children:[/*#__PURE__*/_jsx(\"p\",{className:\"text-sm\",children:message.content}),/*#__PURE__*/_jsx(\"p\",{className:`text-xs mt-1 ${isOwn?'text-green-100':'text-gray-500'}`,children:new Date(message.created_at).toLocaleTimeString()})]})});};export default Messages;","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}